{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"This stack creates 4 subnets, two are public, two are private. They span 2 availability zones. NAT gateways are used for private access to the internet.",
   "Resources":{
      "itsrefarchvpc01":{
         "Type":"AWS::EC2::VPC",
         "Properties":{
            "CidrBlock":{
               "Ref":"VPCCIDR"
            },
            "EnableDnsHostnames":"True",
            "Tags":[
               {
                  "Key":"Name",
                  "Value":"its-ref-arch-vpc01"
               }
            ]
         }
      },
      "itsrefarchpubazadmz":{
         "Type":"AWS::EC2::Subnet",
         "Properties":{
            "VpcId":{
               "Ref":"itsrefarchvpc01"
            },
            "CidrBlock":{
               "Ref":"CidrDMZA"
            },
            "MapPublicIpOnLaunch" : "True",
            "AvailabilityZone":{
               "Fn::Select":[
                  "0",
                  {
                     "Fn::GetAZs":{
                        "Ref":"AWS::Region"
                     }
                  }
               ]
            },
            "Tags":[
               {
                  "Key":"Name",
                  "Value":"its-ref-arch-pub-aza-dmz"
               }
            ]
         }
      },
      "itsrefarchpubazbdmz":{
         "Type":"AWS::EC2::Subnet",
         "Properties":{
            "VpcId":{
               "Ref":"itsrefarchvpc01"
            },
            "CidrBlock":{
               "Ref":"CidrDMZB"
            },
            "MapPublicIpOnLaunch" : "True",
            "AvailabilityZone":{
               "Fn::Select":[
                  "1",
                  {
                     "Fn::GetAZs":{
                        "Ref":"AWS::Region"
                     }
                  }
               ]
            },
            "Tags":[
               {
                  "Key":"Name",
                  "Value":"its-ref-arch-pub-azb-dmz"
               }
            ]
         }
      },
      "itsrefarchpriazaapp":{
         "Type":"AWS::EC2::Subnet",
         "Properties":{
            "VpcId":{
               "Ref":"itsrefarchvpc01"
            },
            "CidrBlock":{
               "Ref":"CidrAppA"
            },
            "AvailabilityZone":{
               "Fn::Select":[
                  "0",
                  {
                     "Fn::GetAZs":{
                        "Ref":"AWS::Region"
                     }
                  }
               ]
            },
            "Tags":[
               {
                  "Key":"Name",
                  "Value":"its-ref-arch-pri-aza-app"
               }
            ]
         }
      },
      "itsrefarchpriazbapp":{
         "Type":"AWS::EC2::Subnet",
         "Properties":{
            "VpcId":{
               "Ref":"itsrefarchvpc01"
            },
            "CidrBlock":{
               "Ref":"CidrAppB"
            },
            "AvailabilityZone":{
               "Fn::Select":[
                  "1",
                  {
                     "Fn::GetAZs":{
                        "Ref":"AWS::Region"
                     }
                  }
               ]
            },
            "Tags":[
               {
                  "Key":"Name",
                  "Value":"its-ref-arch-pri-azb-app"
               }
            ]
         }
      },
      "InternetGateway":{
         "Type":"AWS::EC2::InternetGateway",
         "Properties":{
            "Tags":[
               {
                  "Key":"Name",
                  "Value":"its-ref-arch-igw"
               }
            ]
         }
      },
      "GatewayToInternet":{
         "Type":"AWS::EC2::VPCGatewayAttachment",
         "Properties":{
            "VpcId":{
               "Ref":"itsrefarchvpc01"
            },
            "InternetGatewayId":{
               "Ref":"InternetGateway"
            }
         }
      },
      "NATGatewayAZA":{
         "DependsOn":"GatewayToInternet",
         "Type":"AWS::EC2::NatGateway",
         "Properties":{
            "AllocationId":{
               "Fn::GetAtt":[
                  "EIP",
                  "AllocationId"
               ]
            },
            "SubnetId":{
               "Ref":"itsrefarchpubazadmz"
            }
         }
      },
      "EIP":{
         "Type":"AWS::EC2::EIP",
         "Properties":{
            "Domain":"vpc"
         }
      },
      "NATGatewayAZB":{
         "DependsOn":"GatewayToInternet",
         "Type":"AWS::EC2::NatGateway",
         "Properties":{
            "AllocationId":{
               "Fn::GetAtt":[
                  "EIP2",
                  "AllocationId"
               ]
            },
            "SubnetId":{
               "Ref":"itsrefarchpubazbdmz"
            }
         }
      },
      "EIP2":{
         "Type":"AWS::EC2::EIP",
         "Properties":{
            "Domain":"vpc"
         }
      },
      "itsrefarchpubazallrt":{
         "Type":"AWS::EC2::RouteTable",
         "Properties":{
            "VpcId":{
               "Ref":"itsrefarchvpc01"
            },
            "Tags":[
               {
                  "Key":"Name",
                  "Value":"its-ref-arch-pub-az*-rt"
               }
            ]
         }
      },
      "itsrefarchpriazart":{
         "Type":"AWS::EC2::RouteTable",
         "Properties":{
            "VpcId":{
               "Ref":"itsrefarchvpc01"
            },
            "Tags":[
               {
                  "Key":"Name",
                  "Value":"its-ref-arch-pri-aza-rt"
               }
            ]
         }
      },
      "itsrefarchpriazbrt":{
         "Type":"AWS::EC2::RouteTable",
         "Properties":{
            "VpcId":{
               "Ref":"itsrefarchvpc01"
            },
            "Tags":[
               {
                  "Key":"Name",
                  "Value":"its-ref-arch-pri-azb-rt"
               }
            ]
         }
      },
      "PublicRoute":{
         "Type":"AWS::EC2::Route",
         "DependsOn":"GatewayToInternet",
         "Properties":{
            "RouteTableId":{
               "Ref":"itsrefarchpubazallrt"
            },
            "DestinationCidrBlock":"0.0.0.0/0",
            "GatewayId":{
               "Ref":"InternetGateway"
            }
         }
      },
      "PrivateRouteAZA":{
         "Type":"AWS::EC2::Route",
         "DependsOn":"NATGatewayAZA",
         "Properties":{
            "RouteTableId":{
               "Ref":"itsrefarchpriazart"
            },
            "DestinationCidrBlock":"0.0.0.0/0",
            "NatGatewayId":{
               "Ref":"NATGatewayAZA"
            }
         }
      },
      "PrivateRouteAZB":{
         "Type":"AWS::EC2::Route",
         "DependsOn":"NATGatewayAZB",
         "Properties":{
            "RouteTableId":{
               "Ref":"itsrefarchpriazbrt"
            },
            "DestinationCidrBlock":"0.0.0.0/0",
            "NatGatewayId":{
               "Ref":"NATGatewayAZB"
            }
         }
      },
      "PublicSubnetRouteTableAssociation1":{
         "Type":"AWS::EC2::SubnetRouteTableAssociation",
         "Properties":{
            "SubnetId":{
               "Ref":"itsrefarchpubazadmz"
            },
            "RouteTableId":{
               "Ref":"itsrefarchpubazallrt"
            }
         }
      },
      "PublicSubnetRouteTableAssociation2":{
         "Type":"AWS::EC2::SubnetRouteTableAssociation",
         "Properties":{
            "SubnetId":{
               "Ref":"itsrefarchpubazbdmz"
            },
            "RouteTableId":{
               "Ref":"itsrefarchpubazallrt"
            }
         }
      },
      "PrivateSubnetRouteTableAssociation1":{
         "Type":"AWS::EC2::SubnetRouteTableAssociation",
         "Properties":{
            "SubnetId":{
               "Ref":"itsrefarchpriazaapp"
            },
            "RouteTableId":{
               "Ref":"itsrefarchpriazart"
            }
         }
      },
      "PrivateSubnetRouteTableAssociation3":{
         "Type":"AWS::EC2::SubnetRouteTableAssociation",
         "Properties":{
            "SubnetId":{
               "Ref":"itsrefarchpriazbapp"
            },
            "RouteTableId":{
               "Ref":"itsrefarchpriazbrt"
            }
         }
      }
   },
   "Parameters":{
      "VPCCIDR":{
         "Description":"Network CIDR for VPC. Example: 10.0.1.0/24.",
         "Type":"String",
         "Default":"10.10.10.0/24"
      },
      "CidrDMZA":{
         "Description":"AZ A DMZ CIDR",
         "Type":"String",
         "Default":"10.10.10.0/26"
      },
      "CidrDMZB":{
         "Description":"AZ B DMZ CIDR",
         "Type":"String",
         "Default":"10.10.10.64/26"
      },
      "CidrAppA":{
         "Description":"AZ A Private App Subnet CIDR",
         "Type":"String",
         "Default":"10.10.10.128/26"
      },
      "CidrAppB":{
         "Description":"AZ B Private App Subnet CIDR",
         "Type":"String",
         "Default":"10.10.10.192/26"
      }
   },
   "Outputs": {
      "NetworkStackName": {
         "Value":  {"Ref" : "AWS::StackName" },
         "Export" : {
            "Name" : "NetworkStackName"
          }
      },
      "AccountVPC": {
         "Value": { "Ref" : "itsrefarchvpc01"},
         "Export" : {
            "Name" : { "Fn::Sub" : "${AWS::StackName}-vpcID"}
          }
      },
      "itsrefarchpubazadmz": {
         "Value": { "Ref" : "itsrefarchpubazadmz"},
         "Export" : {
            "Name" : { "Fn::Sub" : "${AWS::StackName}-subnetpubazadmz"}
          }
      },
      "itsrefarchpubazbdmz": {
         "Value": { "Ref" : "itsrefarchpubazbdmz"},
         "Export" : {
            "Name" : { "Fn::Sub" : "${AWS::StackName}-subnetpubazbdmz"}
          }
      },
      "itsrefarchpriazaapp": {
         "Value": { "Ref" : "itsrefarchpriazaapp"},
         "Export" : {
            "Name" : { "Fn::Sub" : "${AWS::StackName}-subnetpriazaapp"}
          }
      },
      "itsrefarchpriazbapp": {
         "Value": { "Ref" : "itsrefarchpriazbapp"},
         "Export" : {
            "Name" : { "Fn::Sub" : "${AWS::StackName}-subnetpriazbapp"}
         }
      }
   }
   
}
